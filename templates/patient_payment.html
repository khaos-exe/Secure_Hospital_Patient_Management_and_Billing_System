{% extends "base.html" %}

{% block title %}Make Payment - Secure Hospital System{% endblock %}

{% block content %}
<a href="{{ url_for('dashboard') }}" class="back-link">‚Üê Back to Dashboard</a>
<h1>Make Payment</h1>
<p class="subtitle">Select a bill and payment method to make a payment</p>

{% if bills|length == 0 %}
<div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
    You don't have any bills to pay at this time.
</div>
{% else %}
<div style="margin-bottom: 30px;">
    <h2 style="font-size: 1.2em; margin-bottom: 15px;">Your Bills</h2>
    <div style="display: grid; gap: 15px;">
        {% for bill in bills %}
        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #fff;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>Billing ID: #{{ bill.billing_id }}</strong><br>
                    <span style="color: #666;">Total: ${{ "%.2f"|format(bill.total_amount) }}</span>
                    {% if bill.paid_amount %}
                    <span style="color: #666;"> | Paid: ${{ "%.2f"|format(bill.paid_amount) }}</span>
                    {% endif %}
                    <br>
                    <span style="color: #666;">Status: {{ bill.status }}</span>
                </div>
                <div>
                    <span class="status-pill {% if bill.status == 'Paid' %}success{% elif bill.status == 'Pending' %}warning{% else %}error{% endif %}">
                        {{ bill.status }}
                    </span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if payment_methods|length == 0 %}
<div style="background: #ffebee; color: #c62828; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
    You don't have any payment methods saved. Please add a payment method first.
    <br><br>
    <a href="{{ url_for('add_payment_method') }}" class="btn">Add Payment Method</a>
</div>
{% else %}
<form method="POST" action="/payment" autocomplete="off" style="max-width: 600px;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <div class="field-card">
        <label for="billing_id">Select Bill <span class="required">*</span></label>
        <select id="billing_id" name="billing_id" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px;">
            <option value="">-- Select a bill --</option>
            {% for bill in bills %}
            <option value="{{ bill.billing_id }}">
                Bill #{{ bill.billing_id }} - ${{ "%.2f"|format(bill.total_amount) }} ({{ bill.status }})
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="field-card">
        <label for="payment_method_id">Payment Method <span class="required">*</span></label>
        <select id="payment_method_id" name="payment_method_id" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px;">
            <option value="">-- Select payment method --</option>
            {% for pm in payment_methods %}
            <option value="{{ pm.payment_method_id }}" {% if pm.is_default %}selected{% endif %}>
                {{ pm.type }} ending in {{ pm.last4 }}{% if pm.is_default %} (Default){% endif %}
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="field-card">
        <label for="payment_amount">Payment Amount ($) <span class="required">*</span></label>
        <input type="number" id="payment_amount" name="payment_amount" step="0.01" min="0.01" required 
               placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px;">
        <div class="hint">Enter the amount you want to pay</div>
    </div>
    
    <button type="submit" class="submit-btn">Process Payment</button>
</form>
{% endif %}

{% if payment_history|length > 0 %}
<div style="margin-top: 40px;">
    <h2 style="font-size: 1.2em; margin-bottom: 15px;">Payment History</h2>
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden;">
            <thead>
                <tr style="background: #f5f5f5;">
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Transaction ID</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Bill #</th>
                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Amount</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Date</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Status</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Details</th>
                </tr>
            </thead>
            <tbody>
                {% for payment in payment_history %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 12px; font-family: monospace; font-size: 0.9em;">#{{ payment.payment_id }}</td>
                    <td style="padding: 12px;">#{{ payment.billing_id }}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 500;">${{ "%.2f"|format(payment.amount) }}</td>
                    <td style="padding: 12px; color: #666;">{{ payment.paid_at.strftime('%Y-%m-%d %H:%M') if payment.paid_at else 'N/A' }}</td>
                    <td style="padding: 12px;">
                        <span class="status-pill {% if payment.status == 'Posted' %}success{% else %}warning{% endif %}">
                            {{ payment.status }}
                        </span>
                    </td>
                    <td style="padding: 12px; color: #666; font-size: 0.9em;">
                        {% if payment.note %}
                        {{ payment.note[:50] }}{% if payment.note|length > 50 %}...{% endif %}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div style="margin-top: 40px; background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; color: #666;">
    <p style="margin: 0;">No payment history yet.</p>
</div>
{% endif %}

{% endblock %}

