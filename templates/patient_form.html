{% extends "base.html" %}

{% block title %}Patient Intake Form - Secure Hospital System{% endblock %}

{% block content %}
<h1>Patient Intake Form</h1>
<p class="subtitle">Secure Hospital Patient Management System</p>

{% if error %}
<div class="alert error">{{ error }}</div>
{% endif %}

<form method="POST" action="/patient" autocomplete="off" class="smart-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="field-card">
        <label for="full_name">Full Name <span class="required">*</span></label>
        <input type="text" id="full_name" name="full_name" autocomplete="name" maxlength="160" value="{{ form_data.full_name|default('') }}" required>
    </div>
    
    <div class="field-card">
        <label for="dob">Date of Birth <span class="required">*</span></label>
        <input type="date" id="dob" name="dob" value="{{ form_data.dob|default('') }}" required>
    </div>
    
    <div class="field-card">
        <label for="email">Email Address <span class="required">*</span></label>
        <input type="email" id="email" name="email" autocomplete="email" value="{{ form_data.email|default('') }}" required>
        <div class="hint">We'll use this for login and updates.</div>
    </div>
    
    <div class="field-card">
        <label for="phone">Phone Number</label>
        <input type="tel" id="phone" name="phone" autocomplete="tel" inputmode="tel" pattern="[0-9\\s\\-]{7,20}" maxlength="20" value="{{ form_data.phone|default('') }}">
        <div class="hint">Digits only; will be encrypted at rest.</div>
    </div>
    
    <div class="field-card">
        <label for="address">Address</label>
        <textarea id="address" name="address" autocomplete="street-address" maxlength="240" placeholder="Street, City, State">{{ form_data.address|default('') }}</textarea>
        <div class="hint">Stored encrypted; visible only to authorized users.</div>
    </div>
    
    <div class="field-card">
        <label for="mrn">Medical Record Number (MRN) <span class="required">*</span></label>
        <input type="text" id="mrn" name="mrn" autocomplete="off" maxlength="64" value="{{ form_data.mrn|default('') }}" required>
        <div class="hint">Required identifier, encrypted at rest.</div>
    </div>
    
    <div class="field-card">
        <label for="diagnosis">Diagnosis</label>
        <textarea id="diagnosis" name="diagnosis" maxlength="800" placeholder="Brief summary for care team">{{ form_data.diagnosis|default('') }}</textarea>
        <div class="hint">Encrypted immediately on submission.</div>
    </div>
    
    <div class="field-card">
        <label for="insurance">Insurance Policy Number</label>
        <input type="text" id="insurance" name="insurance" autocomplete="off" maxlength="64" value="{{ form_data.insurance|default('') }}">
    </div>
    
    <div class="field-card">
        <label for="amount">Billing Amount <span class="required">*</span></label>
        <input type="number" id="amount" name="amount" step="0.01" min="0" autocomplete="off" value="{{ form_data.amount|default('') }}" required>
    </div>
    
    <div class="field-card">
        <label for="card">Payment Card Number <span class="required">*</span></label>
        <input type="text" id="card" name="card" inputmode="numeric" pattern="[0-9]{12,19}" maxlength="23" autocomplete="off" value="{{ form_data.card|default('') }}" required>
        <p class="mask-hint">Full card numbers are encrypted at rest; only the last four are retained for reference.</p>
        <div id="card-preview" class="mask-preview" aria-live="polite">**** **** **** ****</div>
    </div>
    
    <button type="submit" class="submit-btn">Submit Patient Information</button>
</form>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const form = document.querySelector('form');
    const cardInput = document.getElementById('card');
    const phoneInput = document.getElementById('phone');
    const cardPreview = document.getElementById('card-preview');

    if (form) {
        form.addEventListener('submit', function() {
            if (cardInput) {
                cardInput.value = (cardInput.value || '').replace(/\D/g, '');
            }
            if (phoneInput) {
                phoneInput.value = (phoneInput.value || '').replace(/\D/g, '');
            }
        });
    }

    if (cardInput && cardPreview) {
        // Initialize card preview on page load if card has value
        const updateCardPreview = function() {
            const digits = (cardInput.value || '').replace(/\D/g, '').slice(0, 19);
            const masked = digits.replace(/\d(?=\d{4})/g, '*');
            const grouped = masked.match(/.{1,4}/g);
            cardPreview.textContent = grouped ? grouped.join(' ') : '**** **** **** ****';
        };
        updateCardPreview(); // Initialize on load
        cardInput.addEventListener('input', updateCardPreview);
    }
})();
</script>
{% endblock %}
